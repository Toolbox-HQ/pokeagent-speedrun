Bootstrap: docker
From: ubuntu:24.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PATH="/root/.local/bin:$PATH"
    export UV_CONCURRENT_BUILDS=4
    
%post
    apt-get update && \
        apt-get install -y \
            git \
            curl \
            sudo \
            xz-utils \
            ffmpeg \
            libpng16-16 \
            libzip4 \
            libsqlite3-0 \
            libelf1 \
            uuid-runtime \
            liblua5.4-0 && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists/*

    # Install uv
    curl -LsSf https://astral.sh/uv/install.sh | \
    UV_INSTALL_DIR=/app sh

    # Create work directory
    mkdir -p /app
    cd /app

    # Download and install mGBA
    curl -L -o mGBA-0.10.5-ubuntu64-noble.tar.xz \
        https://github.com/mgba-emu/mgba/releases/download/0.10.5/mGBA-0.10.5-ubuntu64-noble.tar.xz

    tar -xf mGBA-0.10.5-ubuntu64-noble.tar.xz
    rm mGBA-0.10.5-ubuntu64-noble.tar.xz

    dpkg -i mGBA-0.10.5-ubuntu64-noble/libmgba.deb

%files
    config /app/
    dconfig /app/
    emulator /app/
    models /app/
    s3_utils /app/
    script /app/
    .python-version /app/
    .s3cfg /app/
    main.py /app/
    pyproject.toml /app/

%post
    cd /app
    . /app/env
    uv sync

%runscript
    cd /app
    exec "$@"
